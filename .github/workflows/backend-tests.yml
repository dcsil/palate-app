name: Backend Tests and Coverage

on:
  push:
    branches: [ main, frontend-testing ]
    paths:
      - 'backend/**'
      - 'pytest.ini'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'pytest.ini'

jobs:
  test:
    name: Run Backend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio
          pip install -r backend/api_search/requirements.txt
      
      - name: Run tests with coverage
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          cd backend
          pytest \
            api_search/tests/ \
            --cov=api_search \
            --cov=services \
            --cov-report=term \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            -v
          
          # Ensure .coverage file exists for PR comments
          coverage combine || true
      
      - name: Generate coverage summary
        if: always()
        run: |
          cd backend
          
          # Check if coverage.xml exists and has valid data
          if [ ! -f "coverage.xml" ]; then
            echo "## ðŸ Backend Test Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Coverage report not generated due to test errors**" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Parse comprehensive coverage data with error handling
          COVERAGE_DATA=$(python -c "
          import xml.etree.ElementTree as ET
          from pathlib import Path
          import sys
          
          try:
              tree = ET.parse('coverage.xml')
              root = tree.getroot()
              
              # Overall stats - handle missing attributes
              line_rate = float(root.attrib.get('line-rate', 0))
              lines_covered = int(root.attrib.get('lines-covered', 0))
              lines_valid = int(root.attrib.get('lines-valid', 0))
              coverage_percent = line_rate * 100
              
              # Count test files
              import glob
              test_files = len(glob.glob('api_search/tests/test_*.py'))
              
              print(f'{coverage_percent:.2f}|{lines_covered}|{lines_valid}|{test_files}', end='')
          except Exception as e:
              print(f'0.00|0|0|0', end='')
              sys.exit(0)
          " 2>/dev/null || echo "0.00|0|0|0")
          
          # Parse the output
          IFS='|' read -r COVERAGE_PERCENT LINES_COVERED LINES_VALID TEST_COUNT <<< "$COVERAGE_DATA"
          
          # Generate comprehensive GitHub Actions summary
          echo "## ðŸ Backend Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Test Files** | ${TEST_COUNT} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Test Directories** | \`api_search/tests/\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | âœ… All tests passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Overall Coverage Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add coverage badge
          if (( $(echo "$COVERAGE_PERCENT >= 80" | bc -l) )); then
            BADGE="ðŸŸ¢"
            STATUS="Excellent"
          elif (( $(echo "$COVERAGE_PERCENT >= 65" | bc -l) )); then
            BADGE="ðŸŸ¡"
            STATUS="Good"
          else
            BADGE="ðŸ”´"
            STATUS="Needs Improvement"
          fi
          
          echo "| Coverage | Lines Covered | Total Lines | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **${COVERAGE_PERCENT}%** | ${LINES_COVERED} | ${LINES_VALID} | ${BADGE} ${STATUS} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“¦ Module-by-Module Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage analysis across **backend codebase**:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse and display package details with error handling
          python -c "
          import xml.etree.ElementTree as ET
          
          try:
              tree = ET.parse('coverage.xml')
              root = tree.getroot()
              
              print('| Module | Coverage | Lines Covered | Total Lines |')
              print('|--------|----------|---------------|-------------|')
              
              packages_found = False
              for package in root.findall('.//package'):
                  packages_found = True
                  pkg_name = package.attrib['name'].replace('.', '/')
                  pkg_line_rate = float(package.attrib.get('line-rate', 0))
                  pkg_coverage = pkg_line_rate * 100
                  pkg_lines_covered = int(package.attrib.get('lines-covered', 0))
                  pkg_lines_valid = int(package.attrib.get('lines-valid', 0))
                  
                  if pkg_lines_valid > 0:  # Only show packages with code
                      badge = 'ðŸŸ¢' if pkg_coverage >= 80 else 'ðŸŸ¡' if pkg_coverage >= 65 else 'ðŸ”´'
                      print(f'| {badge} \`{pkg_name}\` | **{pkg_coverage:.1f}%** | {pkg_lines_covered} | {pkg_lines_valid} |')
              
              if not packages_found:
                  print('| â„¹ï¸  | No packages found | - | - |')
          except Exception as e:
              print('| âš ï¸  | Error parsing coverage data | - | - |')
          " >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Coverage Scope" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This report covers the **backend API search module**, including:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **API Search Module** (\`backend/api_search/\`)" >> $GITHUB_STEP_SUMMARY
          echo "  - LangChain agents (rank agent, single source)" >> $GITHUB_STEP_SUMMARY
          echo "  - Agent tools (Google Places, Firestore DB)" >> $GITHUB_STEP_SUMMARY
          echo "  - Service integrations (Google Places, Firestore)" >> $GITHUB_STEP_SUMMARY
          echo "  - FastAPI routers and dependencies" >> $GITHUB_STEP_SUMMARY
          echo "  - Data models (requests, responses)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Coverage report artifacts**: Available for download for 30 days" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ˆ **Trend tracking**: Compare coverage across commits and PRs" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload coverage to Codecov (optional)
        uses: codecov/codecov-action@v4
        with:
          files: backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
        continue-on-error: true
      
      - name: Archive coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: |
            backend/coverage.xml
            backend/htmlcov/
          retention-days: 30
      
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          COVERAGE_DATA_BRANCH: coverage-data
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 65
        continue-on-error: true
        env:
          COVERAGE_PATH: backend
